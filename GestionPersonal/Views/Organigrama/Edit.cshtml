@model GPSInformation.Models.OrganigramaVersion

@{
    ViewData["Title"] = "Editar organigrama";
}

    <h2>@ViewData["Title"]</h2>

    <div id="app_organigrama">
        @if (Model.Autirizada == 2)
        {
            <div class="alert alert-primary mg-b-0" role="alert">
              Esta versión de organigrama se encuentra activa por  ello no se podrá modificar a menos que autorices otra
            </div>
        }
        <a href="#puestosselect" style="display: none" id="element" data-toggle="modal">content</a>
        <div id="contactLogs" class="tab-pane pd-20 pd-xl-25 active">
            <div class="d-flex align-items-center justify-content-between mg-b-30">
                <h4 class="tx-15 mg-b-0"></h4>

                <div class="btn-group btn-sm btn-white d-flex align-items-center" role="group" aria-label="Basic example">

                    @if (Model.Autirizada == 1)
                    {
                        <button href="#addprimero" type="button" class="btn btn-white"><i class="icon ion-md-time mg-r-5 tx-16 lh--9"></i>Agregar primer nodo</button>
                        <form asp-action="Autorizar">
                            <input type="hidden" name="IdVersion" value="@Model.IdOrganigramaVersion" />
                            <button type="submit" class="btn btn-white">Autorizar esta versión</button>
                        </form>
                    }
                </div>
            </div>
        </div>
        <div id="tree"></div>
        <div class="modal fade" id="puestosselect" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content tx-14">
                    <div class="modal-header">
                        <h6 class="modal-title" id="exampleModalLabel">Selecciona un puesto</h6>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <select class="form-control  " v-model="selected" disabled>
                                <option v-for="option in Puestos" v-bind:value="option.idPuesto">
                                    {{ option.dpu }} - {{ option.descripcion }}
                                </option>
                            </select>
                            <label>Puesto</label>
                            <select class="form-control" id="NewPuestoa">
                                <option v-for="option in Puestos" v-bind:value="option.idPuesto">
                                    {{ option.dpu }} - {{ option.descripcion }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary tx-13" data-dismiss="modal">Close</button>
                        <button type="button" v-on:click="AddNode()" class="btn btn-primary tx-13">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="addprimero" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content tx-14">
                    <div class="modal-header">
                        <h6 class="modal-title" id="exampleModalLabel">Selecciona un puesto principal</h6>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">

                            <label>Puesto</label>
                            <select class="form-control  " id="NewPuesto">
                                <option v-for="option in Puestos" v-bind:value="option.idPuesto">
                                    {{ option.dpu }} - {{ option.descripcion }}
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary tx-13" data-dismiss="modal">Close</button>
                        <button type="button" v-on:click="AddFirstNode()" class="btn btn-primary tx-13">Agregar primer puesto</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    @*<script src="~/js/getorgchart1.js"></script>*@
    <script src="https://balkangraph.com/js/latest/OrgChart.js"></script>
    <script>
        var app_organigrama = new Vue({
            el: "#app_organigrama",
            data: {
                Puestos: [],
                chart: null,
                selected: 0,
                hasmainPosition: true
            },
            async mounted() {
                await this.GetPuestos();
                
                this.StartChartOrg();
                $('.select2').select2({
                    placeholder: 'Choose one',
                    searchInputPlaceholder: 'Search options'
                });
                await this.GetEstructura();
            },
            methods: {
                AddFirstNode: async function () {
                    var selected = document.getElementById("NewPuesto").value
                    let params = new URLSearchParams();
                    params.append('IdPuesto', selected);
                    params.append('IdPuestoParent', 0);
                    params.append('IdVersion', '@Model.IdOrganigramaVersion');
                    await axios.post('@Url.Action("AddFirstNode","Organigrama")', params, null).then(response => {
                        alert(response.data)
                        ShowMessageErrorShort(response.data,"success")
                    }).catch(error => {
                        if (error.response) {
                            if (error.response.status === 400) {
                                console.log(error.response)
                                ShowMessageErrorShort(error.response.data,"error")
                            }
                        }
                    }).finally()
                },
                GetPuestos: async function () {
                    await axios.post('@Url.Action("GetPuestos","Organigrama")', null, null).then(response => {
                        this.Puestos = response.data;
                        console.log(response.data)
                    }).catch(error => {
                        if (error.response) {
                            if (error.response.status === 400) {
                                console.log(error.response)
                                ShowMessageErrorShort(error.response.data,"error")
                            }
                        }
                    }).finally()
                },
                GetEstructura: async function () {
                    ShowMessageErrorShort("Recopilando estructura de la versión","success")
                    let params = new URLSearchParams();
                    params.append('IdVersion', '@Model.IdOrganigramaVersion');
                    await axios.post('@Url.Action("GetNodes","Organigrama")', params, null).then(response => {
                        response.data.forEach((e,i) => {
                            if (e.idPuestoParent == 0) {
                                this.chart.add({ id: e.idPuesto, name: e.descripcion, title: e.dpu });
                            } else {
                                this.chart.add({ id: e.idPuesto, pid: e.idPuestoParent, name: e.descripcion, title: e.dpu });
                            }
                        })
                        //this.chart.draw(OrgChart.action.init);
                        
                    }).catch(error => {
                        if (error.response) {
                            if (error.response.status === 400) {
                                console.log(error.response)
                                ShowMessageErrorShort(error.response.data,"error")
                            }
                        }
                    }).finally()
                },
                StartChartOrg: function () {
                    this.chart = new OrgChart(document.getElementById("tree"), {
                        template: "ula",
                        nodeBinding: {
                            field_0: "name",
                            field_1: "title",
                        },
                        nodeMenu: {
                            add: { text: "Agregar nuevo",onClick: this.ShowAdd },
                            remove: { text: "Deliminar",onClick: this.Remove },
                        }

                    });
                    this.chart.draw(OrgChart.action.init);
                },
                ShowAdd: function (a) {
                    this.selected = a;
                    console.log(a)
                    document.getElementById("element").click();
                },
                Remove: function (a, e) {
                    console.log(a)
                    console.log(e)
                    Swal.fire({
                        title: "¿Deseas eliminar este elemento del organigrama?",
                        text: "",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#3085d6',
                        cancelButtonColor: '#d33',
                        confirmButtonText: 'Si, eliminalo!'
                    }).then((result) => {
                        if (result.value) {
                            let params = new URLSearchParams();
                            params.append('IdPuesto', a);
                            params.append('IdVersion', '@Model.IdOrganigramaVersion');
                            axios.post('@Url.Action("Remove","Organigrama")', params, null).then(response => {
                                ShowMessageErrorShort("Puesto eliminado","success")
                                this.GetEstructura();
                                this.chart.remove(a);
                            }).catch(error => {
                                console.error(error)
                                if (error.response) {
                                    if (error.response.status === 400) {
                                        console.log(error.response)
                                        ShowMessageErrorShort(error.response.data,"error")
                                    }
                                }
                            }).finally()
                        }
                    })
                },
                AddNode:  function () {
                    var selected = document.getElementById("NewPuestoa").value
                    
                    let params = new URLSearchParams();
                    params.append('IdPuesto', selected);
                    params.append('IdPuestoParent', this.selected);
                    params.append('IdVersion', '@Model.IdOrganigramaVersion');
                    axios.post('@Url.Action("AddNode","Organigrama")', params, null).then(response => {
                        document.getElementById("element").click();
                        ShowMessageErrorShort("Nuevo puesto agregado","success")
                        this.GetEstructura();
                    }).catch(error => {
                        if (error.response) {
                            if (error.response.status === 400) {
                                console.log(error.response)
                                ShowMessageErrorShort(error.response.data,"error")
                            }
                        }
                    }).finally()
                }
            }
        });
    </script>
}
